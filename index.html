<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta
      name="description"
      content="This website determines the infusion rates for anesthetic drugs."
    />
    <title>Anesthesia Infusion Calculator</title>
    <link rel="icon" type="image/x-icon" href="syringe.png" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Prompt:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        --bg: #0b1220;
        --card: #121a2b;
        --muted: #8aa0c5;
        --accent: #53b0ff;
        --good: #37d67a;
        --warn: #ffb020;
        --bad: #ff5e73;
      }
      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        font-family: system-ui, -apple-system, Segoe UI, Roboto, Inter,
          Helvetica, Arial, sans-serif;
        background: linear-gradient(135deg, #0a1020, #0d1630);
      }
      [lang="th"] {
        font-family: "Prompt", system-ui, -apple-system, "Segoe UI", Roboto,
          Inter, sans-serif;
      }
      .wrap {
        max-width: 920px;
        margin: auto;
        padding: clamp(16px, 3vw, 32px);
        color: #e9f1ff;
      }
      h1 {
        font-size: clamp(20px, 3.8vw, 30px);
        margin: 0 0 8px;
      }
      p.sub {
        color: var(--muted);
        margin: 0 0 18px;
      }
      .card {
        background: var(--card);
        border: 1px solid rgba(255, 255, 255, 0.06);
        border-radius: 16px;
        padding: clamp(14px, 2.4vw, 22px);
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.35);
        min-width: 300px;
      }
      .grid {
        display: grid;
        gap: 12px;
      }
      @media (min-width: 540px) {
        .grid {
          grid-template-columns: 1fr 1fr;
        }
      }
      label {
        display: block;
        font-size: 12px;
        letter-spacing: 0.06em;
        color: var(--muted);
        margin: 6px 0 6px;
      }
      input,
      select,
      button,
      textarea {
        width: 100%;
        padding: 12px 12px;
        border-radius: 12px;
        border: 1px solid rgba(255, 255, 255, 0.1);
        background: #0b1324;
        color: #eef3ff;
        font-size: 16px;
        outline: none;
      }
      input::placeholder {
        color: #6e84a8;
      }
      .controls {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
      }
      .toggle {
        appearance: none;
        width: 100%;
        cursor: pointer;
        background: var(--card);
        border: 1px solid rgba(255, 255, 255, 0.15);
      }
      .toggle.active {
        background: #10233b;
        border-color: var(--accent);
        box-shadow: 0 0 0 2px rgba(83, 176, 255, 0.2) inset;
      }
      .result {
        margin-top: 14px;
        padding: 14px;
        border-radius: 12px;
        background: #0f1b31;
        border: 1px solid rgba(83, 176, 255, 0.25);
      }
      .result h2 {
        margin: 0 0 4px;
        font-size: clamp(18px, 3vw, 24px);
      }
      .result .value {
        font-size: clamp(22px, 4.5vw, 34px);
        font-weight: 700;
        letter-spacing: 0.02em;
      }
      .hint {
        color: var(--muted);
        font-size: 13px;
        margin-top: 8px;
        line-height: 1.5;
      }
      .ok {
        color: var(--good);
      }
      .warn {
        color: var(--warn);
      }
      .bad {
        color: var(--bad);
      }
      code {
        background: #0b1324;
        padding: 2px 6px;
        border-radius: 6px;
        border: 1px solid rgba(255, 255, 255, 0.08);
        overflow-wrap: break-word;
      }

      /* Color chip beside Medicine select */
      .chip-row {
        display: flex;
        gap: 8px;
        align-items: center;
      }
      .chip {
        width: 50px;
        height: 44px;
        border-radius: 8px;
        border: 1px solid rgba(255, 255, 255, 0.35);
        box-shadow: inset 0 0 0 1px rgba(0, 0, 0, 0.25);
      }

      .share {
        display: flex;
        gap: 8px;
        align-items: center;
        margin-top: 10px;
        flex-wrap: wrap; /* allow wrapping on very small screens */
      }
      .share input {
        flex: 1;
      }
      .share input[type="text"] {
        color: var(--muted);
      }
      .share button {
        width: 128px;
      }

      /* Off-screen QR container (used for generation only) */
      #qrcode {
        position: absolute;
        left: -9999px;
        width: 0;
        height: 0;
        overflow: hidden;
      }
    </style>
  </head>
  <body>
    <div class="wrap">
      <h1>Anesthesia Infusion Calculator</h1>
      <p class="sub">
        This calculator converts dose (mcg/kg/min) ⇄ infusion rate (mL/hr).
      </p>

      <div class="card">
        <!-- Medicine + Concentration -->
        <div class="grid">
          <div>
            <label for="drug">Medicine</label>
            <div class="chip-row">
              <div id="drugChip" class="chip" aria-hidden="true"></div>
              <select id="drug" aria-label="Medicine selector"></select>
            </div>
          </div>
          <div>
            <label for="conc">Concentration</label>
            <select id="conc" aria-label="Concentration selector"></select>
          </div>
        </div>

        <!-- Weight (full width under the row above) -->
        <div style="margin-top: 12px">
          <label for="B">Weight (kg)</label>
          <input
            id="B"
            type="number"
            step="0.1"
            min="0"
            placeholder="e.g., 70.0"
            inputmode="decimal"
            onclick="this.select();"
          />
        </div>

        <div class="controls" style="margin: 12px 0">
          <button id="modeBtn" class="toggle">
            mcg/kg/min → mL/hr (Tap to change mode)
          </button>
        </div>

        <!-- Forward (Dose → Rate) -->
        <div id="forward">
          <div>
            <label for="P">Dose (mcg/kg/min)</label>
            <input
              id="P"
              type="number"
              step="0.01"
              min="0"
              placeholder="e.g., 5.00"
              inputmode="decimal"
              onclick="this.select();"
            />
          </div>
          <div style="margin-top: 12px">
            <label>Infusion rate (mL/hr)</label>
            <input id="Rate" type="text" readonly />
          </div>
        </div>

        <!-- Reverse (Rate → Dose) -->
        <div id="reverse" style="display: none">
          <div>
            <label for="RateIn">Infusion rate (mL/hr)</label>
            <input
              id="RateIn"
              type="number"
              step="0.01"
              min="0"
              placeholder="e.g., 15.00"
              inputmode="decimal"
              onclick="this.select();"
            />
          </div>
          <div style="margin-top: 12px">
            <label>Dose (mcg/kg/min)</label>
            <input id="Pout" type="text" readonly />
          </div>
        </div>

        <!-- Hidden Q fields (kept for logic, not shown) -->
        <div style="display: none" aria-hidden="true">
          <input id="Qf" type="text" readonly />
          <input id="Qr" type="text" readonly />
        </div>

        <div class="result" id="summary">
          <h2 id="resTitle">Result</h2>
          <div class="value" id="resValue">—</div>
          <div class="hint" id="limits"></div>
          <div class="hint" id="rangeNote"></div>
        </div>

        <div class="share">
          <input class="link" id="shareLink" type="text" readonly />
          <button id="copyBtn" type="button">Copy link</button>
          <button id="qrBtn" type="button">Share QR</button>
        </div>

        <!-- Off-screen QR code generator target -->
        <div id="qrcode" aria-hidden="true"></div>
      </div>
    </div>

    <!-- QR code library -->
    <script src="https://cdn.jsdelivr.net/npm/davidshimjs-qrcodejs/qrcode.min.js"></script>

    <script>
      /* ------------------ Drug configuration (colors + defaults) ------------------ */
      const DRUGS = [
        {
          id: "dopamine",
          name: "Dopamine",
          pMin: 1,
          pMax: 50,
          conc: ["1:1", "2:1"],
          color: "#6cc866",
          defaultP: 1.0,
          defaultConc: "1:1",
        },
        {
          id: "dobutamine",
          name: "Dobutamine",
          pMin: 1,
          pMax: 40,
          conc: ["1:1", "2:1"],
          color: "#f8d761",
          defaultP: 1.0,
          defaultConc: "1:1",
        },
        {
          id: "adrenaline",
          name: "Adrenaline",
          pMin: 0.01,
          pMax: null,
          conc: ["1:10"],
          color: "#feb1dc",
          defaultP: 0.1,
          defaultConc: "1:10",
        },
        {
          id: "levophed",
          name: "Levophed (Norepinephrine)",
          pMin: 0.01,
          pMax: 3,
          conc: ["8:100", "4:100", "4:250"],
          color: "#751be3",
          defaultP: 0.1,
          defaultConc: "4:100",
        },
        {
          id: "primacor",
          name: "Primacor (Milrinone)",
          pMin: 0.01,
          pMax: null,
          conc: ["1:5"],
          color: "#d088f7",
          defaultP: 0.1,
          defaultConc: "1:5",
        },
        {
          id: "ntg",
          name: "NTG (Nitroglycerine)",
          pMin: 1,
          pMax: null,
          conc: ["1:1", "2:1"],
          color: "#e87c1e",
          defaultP: 1.0,
          defaultConc: "1:1",
        },
      ];
      const DRUG_INDEX = Object.fromEntries(DRUGS.map((d) => [d.id, d]));

      /* Synonyms for URL parsing */
      const SYNS = {
        norepinephrine: "levophed",
        norepi: "levophed",
        noradrenaline: "levophed",
        epinephrine: "adrenaline",
        milrinone: "primacor",
        nitroglycerin: "ntg",
        nitroglycerine: "ntg",
        // short aliases
        dopa: "dopamine",
        dobu: "dobutamine",
        adr: "adrenaline",
      };

      /* ---------- i18n (English / Thai) ---------- */
      let LANG = "en";
      const I18N = {
        en: {
          below: "Below min",
          within: "Within range",
          above: "Above max",
          range(min, max, drug) {
            return ` • Range: <b>${min}</b> to <b>${max}</b> mcg/kg/min for ${drug}.`;
          },
          limits(b, conc, pMax, maxRate) {
            return `For weight <b>${b} kg</b> and concentration <b>${conc}</b>, max dose is <b>${pMax} mcg/kg/min</b> → max infusion <b>${maxRate} mL/hr</b>.`;
          },
          noMax(drug) {
            return `No specified maximum dose in table for ${drug}.`;
          },
          modeForward: "mcg/kg/min → mL/hr (Tap to change mode)",
          modeReverse: "mL/hr → mcg/kg/min (Tap to change mode)",
        },
        th: {
          below: "ต่ำกว่าเกณฑ์",
          within: "อยู่ในเกณฑ์",
          above: "สูงกว่าเกณฑ์",
          range(min, max, drug) {
            return ` • ขนาดที่กำหนด: <b>${min}</b> ถึง <b>${max} mcg/kg/min</b> สำหรับ <b>${drug}</b>.`;
          },
          limits(b, conc, pMax, maxRate) {
            return `สำหรับน้ำหนัก <b>${b} kg</b> และความเข้มข้น <b>${conc}</b>, Dose สูงสุดคือ <b>${pMax} mcg/kg/min</b> → Infusion rate สูงสุด <b>${maxRate} mL/hr</b>.`;
          },
          noMax(drug) {
            return `ไม่มีการระบุขนาดยาสูงสุดในตารางสำหรับ ${drug}.`;
          },
          modeForward: "mcg/kg/min → mL/hr (กดเพื่อเปลี่ยนโหมด)",
          modeReverse: "mL/hr → mcg/kg/min (กดเพื่อเปลี่ยนโหมด)",
        },
      };
      const dict = () => (LANG === "th" ? I18N.th : I18N.en);
      const normalizeLang = (s) =>
        ["th", "thai", "th-th"].includes((s || "").toLowerCase()) ? "th" : "en";

      /* ------------------ DOM helpers ------------------ */
      const $ = (id) => document.getElementById(id);
      const drugSel = $("drug"),
        concSel = $("conc"),
        drugChip = $("drugChip");
      const modeBtn = $("modeBtn");
      const forwardDiv = $("forward"),
        reverseDiv = $("reverse");
      const P = $("P"),
        B = $("B"),
        Qf = $("Qf"),
        Rate = $("Rate");
      const RateIn = $("RateIn"),
        Qr = $("Qr"),
        Pout = $("Pout");
      const resTitle = $("resTitle"),
        resValue = $("resValue"),
        limits = $("limits"),
        rangeNote = $("rangeNote");
      const shareLink = $("shareLink"),
        copyBtn = $("copyBtn"),
        qrBtn = $("qrBtn");
      const qrContainer = $("qrcode");

      let mode = "forward";
      let booting = true;

      /* ------------------ Utils ------------------ */
      const to2 = (x) => (Number.isFinite(+x) ? (+x).toFixed(2) : "");
      const to1 = (x) => (Number.isFinite(+x) ? (+x).toFixed(1) : "");
      const to3 = (x) => (Number.isFinite(+x) ? (+x).toFixed(3) : "");
      const parseNum = (v) => {
        const n = Number(v);
        return Number.isFinite(n) ? n : null;
      };

      /* ------------------ Core math ------------------ */
      const computeQ = (B, A) => (0.06 * B) / A; // mL/hr per (mcg/kg/min)
      const computeRate = (P, Q) => P * Q; // mL/hr
      const computeP = (rate, Q) => rate / Q; // mcg/kg/min
      function pWithinRange(p, d) {
        if (p == null || !isFinite(p)) return null;
        if (d.pMax == null) return p >= d.pMin ? "ok" : "low";
        if (p < d.pMin) return "low";
        if (p > d.pMax) return "high";
        return "ok";
      }

      /* ------------------ URL parsing ------------------ */
      function normalizeSlug(s) {
        if (!s) return null;
        s = s.trim().toLowerCase();
        if (SYNS[s]) s = SYNS[s];
        return s;
      }
      function parseHashParts() {
        const raw = (location.hash || "").replace(/^#/, "");
        let path = "",
          qs = "";
        if (!raw) return { path: "", qs: "" };
        if (raw.startsWith("/")) {
          const ix = raw.indexOf("?");
          if (ix >= 0) {
            path = raw.slice(1, ix);
            qs = raw.slice(ix + 1);
          } else {
            path = raw.slice(1);
          }
        } else if (raw.startsWith("?")) {
          qs = raw.slice(1);
        } else if (raw.includes("=")) {
          qs = raw;
        } else {
          path = raw;
        }
        return { path, qs };
      }
      function getParamsFromURL() {
        const url = new URL(location.href);
        let drug = normalizeSlug(
          url.searchParams.get("drug") ||
            url.searchParams.get("med") ||
            url.searchParams.get("medicine")
        );
        let modeRaw =
          url.searchParams.get("mode") ||
          url.searchParams.get("m") ||
          url.searchParams.get("reverse") ||
          url.searchParams.get("rev");
        let concRaw =
          url.searchParams.get("conc") ||
          url.searchParams.get("concentration") ||
          url.searchParams.get("a");
        let pRaw = url.searchParams.get("p") || url.searchParams.get("dose");
        let bRaw =
          url.searchParams.get("b") ||
          url.searchParams.get("wt") ||
          url.searchParams.get("weight");
        let rateRaw =
          url.searchParams.get("rate") ||
          url.searchParams.get("mlhr") ||
          url.searchParams.get("mlh") ||
          url.searchParams.get("r");
        let langRaw =
          url.searchParams.get("lang") ||
          url.searchParams.get("language") ||
          url.searchParams.get("locale");

        // Fallback: hash
        const { path, qs } = parseHashParts();
        const hashParams = new URLSearchParams(qs || "");
        if (!drug)
          drug =
            normalizeSlug(path) ||
            normalizeSlug(
              hashParams.get("drug") ||
                hashParams.get("med") ||
                hashParams.get("medicine")
            );
        if (modeRaw == null)
          modeRaw =
            hashParams.get("mode") ||
            hashParams.get("m") ||
            hashParams.get("reverse") ||
            hashParams.get("rev");
        if (concRaw == null)
          concRaw =
            hashParams.get("conc") ||
            hashParams.get("concentration") ||
            hashParams.get("a");
        if (pRaw == null) pRaw = hashParams.get("p") || hashParams.get("dose");
        if (bRaw == null)
          bRaw =
            hashParams.get("b") ||
            hashParams.get("wt") ||
            hashParams.get("weight");
        if (rateRaw == null)
          rateRaw =
            hashParams.get("rate") ||
            hashParams.get("mlhr") ||
            hashParams.get("mlh") ||
            hashParams.get("r");
        if (langRaw == null)
          langRaw =
            hashParams.get("lang") ||
            hashParams.get("language") ||
            hashParams.get("locale");

        // Fallback: path segment
        if (!drug) {
          const segs = (url.pathname || "").split("/").filter(Boolean);
          if (segs.length) {
            drug = normalizeSlug(segs[segs.length - 1]);
          }
        }

        const modeVal = (() => {
          const s = (modeRaw || "").toString().toLowerCase();
          if (["reverse", "rev", "r"].includes(s)) return "reverse";
          if (["1", "true", "yes", "on"].includes(s)) return "reverse";
          return "forward";
        })();

        const conc = concRaw ? concRaw.replace(/\s+/g, "") : null;
        const p = parseNum(pRaw);
        the_b = parseNum(bRaw);
        const b = the_b; // keep original naming but allow lint fix
        const rate = parseNum(rateRaw);
        const lang = normalizeLang(langRaw || LANG);
        return { drug, mode: modeVal, conc, p, b, rate, lang };
      }

      /* ------------------ Build & write query URL ------------------ */
      function buildShareParams() {
        const params = new URLSearchParams();
        params.set("drug", drugSel.value);
        params.set("mode", mode);
        params.set("lang", LANG);
        if (concSel.value) params.set("conc", concSel.value);

        if (mode === "forward") {
          if (P.value) params.set("p", to2(P.value));
          if (B.value) params.set("b", to1(B.value));
          if (Rate.value) params.set("rate", to2(Rate.value));
        } else {
          if (RateIn.value) params.set("rate", to2(RateIn.value));
          if (B.value) params.set("b", to1(B.value));
          if (Pout.value) params.set("p", to2(Pout.value));
        }
        return params;
      }
      function buildURLWithParams() {
        const url = new URL(location.href);
        url.search = buildShareParams().toString();
        url.hash = "";
        return url.toString();
      }
      let urlTimer = null;
      const URL_DEBOUNCE_MS = 250;
      function writeURLFromState_query() {
        const newUrl = buildURLWithParams();
        history.replaceState(null, "", newUrl);
      }
      function scheduleURLUpdate() {
        clearTimeout(urlTimer);
        urlTimer = setTimeout(writeURLFromState_query, URL_DEBOUNCE_MS);
      }
      function updateShareLink() {
        shareLink.value = buildURLWithParams();
      }

      /* ------------------ UI & state ------------------ */
      function populateDrugOptions() {
        for (const d of DRUGS) {
          const opt = document.createElement("option");
          opt.value = d.id;
          opt.textContent = d.name;
          drugSel.appendChild(opt);
        }
      }
      function populateConcs() {
        const d = DRUG_INDEX[drugSel.value];
        concSel.innerHTML = "";
        d.conc.forEach((c) => {
          const opt = document.createElement("option");
          opt.value = c;
          opt.textContent = c;
          concSel.appendChild(opt);
        });
      }
      function updateChip() {
        const d = DRUG_INDEX[drugSel.value];
        drugChip.style.background = d ? d.color : "#444";
        drugChip.title = d ? d.name : "";
      }
      function parseA() {
        const [x, y] = concSel.value.split(":").map(Number);
        return x / y;
      }
      function showMode(newMode) {
        mode = newMode;
        forwardDiv.style.display = mode === "forward" ? "" : "none";
        reverseDiv.style.display = mode === "reverse" ? "" : "none";
        modeBtn.classList.toggle("active", mode === "reverse");
        const D = dict();
        modeBtn.textContent =
          mode === "forward" ? D.modeForward : D.modeReverse;
      }
      function setIfProvided(inputEl, val, fmt) {
        if (val == null || !isFinite(val)) return;
        inputEl.value = fmt ? fmt(val) : val;
      }

      /* --------- Apply per-drug defaults (dose + concentration) --------- */
      function applyDrugDefaults(force = false) {
        const d = DRUG_INDEX[drugSel.value];
        if (!d) return;

        // concentration default if invalid/missing or forced
        const allowed = Array.from(concSel.options).map((o) => o.value);
        if (force || !concSel.value || !allowed.includes(concSel.value)) {
          if (d.defaultConc && allowed.includes(d.defaultConc)) {
            concSel.value = d.defaultConc;
          }
        }

        // forward-dose default if empty or forced (harmless in reverse)
        if (force || !P.value) {
          if (d.defaultP != null) P.value = to2(d.defaultP);
        }
      }

      /* ------------------ Recalc ------------------ */
      function recalc() {
        const d = DRUG_INDEX[drugSel.value];
        const A = parseA();
        const D = dict();

        const b = Number(B.value);
        const Q = computeQ(b, A);

        if (mode === "forward") {
          const p = Number(P.value);
          Qf.value = isFinite(Q) ? to3(Q) : "";
          const rate = computeRate(p, Q);
          Rate.value = isFinite(rate) ? to2(rate) : "";
          resTitle.textContent = "Infusion rate (mL/hr)";
          resValue.textContent = isFinite(rate) ? `${to2(rate)} mL/hr` : "—";
          if (d.pMax != null && isFinite(Q)) {
            const maxRate = computeRate(d.pMax, Q);
            limits.innerHTML = D.limits(
              isFinite(b) ? to1(b) : "—",
              concSel.value,
              d.pMax.toFixed(2),
              to2(maxRate)
            );
          } else {
            limits.textContent = D.noMax(d.name);
          }
          const status = pWithinRange(p, d);
          rangeNote.innerHTML = rangeLine(d, status);
        } else {
          const rateIn = Number(RateIn.value);
          Qr.value = isFinite(Q) ? to3(Q) : "";
          const p = computeP(rateIn, Q);
          Pout.value = isFinite(p) ? to2(p) : "";
          resTitle.textContent = "Required Dose (mcg/kg/min)";
          resValue.textContent = isFinite(p) ? `${to2(p)} mcg/kg/min` : "—";
          if (d.pMax != null && isFinite(Q)) {
            const maxRate = computeRate(d.pMax, Q);
            limits.innerHTML = D.limits(
              isFinite(b) ? to1(b) : "—",
              concSel.value,
              d.pMax.toFixed(2),
              to2(maxRate)
            );
          } else {
            limits.textContent = D.noMax(d.name);
          }
          const status = pWithinRange(p, d);
          rangeNote.innerHTML = rangeLine(d, status);
        }

        if (!booting) {
          updateShareLink();
          scheduleURLUpdate();
        }
      }
      function rangeLine(d, status) {
        const D = dict();
        const minTxt = d.pMin != null ? d.pMin.toFixed(2) : "—";
        const maxTxt = d.pMax != null ? d.pMax.toFixed(2) : "no max";
        const cls =
          status === "high" ? "bad" : status === "low" ? "warn" : "ok";
        const label =
          status === "high" ? D.above : status === "low" ? D.below : D.within;
        return `<span class="${cls}">${label}</span>${D.range(
          minTxt,
          maxTxt,
          d.name
        )}`;
      }

      /* ------------------ QR generation & download ------------------ */
      function downloadQRForCurrentLink() {
        const urlToEncode = buildURLWithParams(); // always use fresh canonical URL
        if (!window.QRCode) {
          alert("QR generator not loaded.");
          return;
        }

        // Clean container then build a fresh 512px QR (good print/share quality)
        qrContainer.innerHTML = "";
        const qr = new QRCode(qrContainer, {
          text: urlToEncode,
          width: 512,
          height: 512,
          colorDark: "#000000",
          colorLight: "#ffffff",
          correctLevel: QRCode.CorrectLevel.H,
        });

        // Grab canvas or img data
        setTimeout(() => {
          let dataUrl = "";
          const canvas = qrContainer.querySelector("canvas");
          if (canvas && canvas.toDataURL) {
            dataUrl = canvas.toDataURL("image/png");
          } else {
            const img = qrContainer.querySelector("img");
            if (img && img.src) dataUrl = img.src;
          }
          if (!dataUrl) {
            alert("Failed to generate QR image.");
            return;
          }

          // Compose a helpful filename
          const d = DRUG_INDEX[drugSel.value];
          const fname = `infusion-qr_${drugSel.value}_${mode}.png`;

          const a = document.createElement("a");
          a.href = dataUrl;
          a.download = fname;

          // Safari old fallback
          if (typeof a.download === "undefined") {
            window.open(dataUrl, "_blank");
          } else {
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
          }
        }, 0); // allow QRCode to render into the container
      }

      /* ------------------ Events ------------------ */
      function attachEvents() {
        [drugSel, concSel, P, RateIn, B].forEach((el) =>
          el.addEventListener("input", recalc)
        );

        modeBtn.addEventListener("click", () => {
          showMode(mode === "forward" ? "reverse" : "forward");
          recalc();
        });

        drugSel.addEventListener("change", () => {
          populateConcs();
          updateChip();
          applyDrugDefaults(true); // switch to this drug’s defaults
          recalc();
        });

        copyBtn.addEventListener("click", async () => {
          try {
            await navigator.clipboard.writeText(shareLink.value);
            copyBtn.textContent = "Copied!";
            setTimeout(() => (copyBtn.textContent = "Copy link"), 1200);
          } catch {
            shareLink.select();
            document.execCommand && document.execCommand("copy");
          }
        });

        qrBtn.addEventListener("click", downloadQRForCurrentLink);

        window.addEventListener("popstate", () => {
          booting = true;
          hydrateFromURL();
          booting = false;
          recalc();
        });

        window.addEventListener("hashchange", () => {
          booting = true;
          hydrateFromURL();
          booting = false;
          recalc();
        });
      }

      /* ------------------ Hydration from URL ------------------ */
      function hydrateFromURL() {
        const { drug, mode: m, conc, p, b, rate, lang } = getParamsFromURL();

        // Language (also set <html lang> for Thai font)
        LANG = normalizeLang(lang);
        document.documentElement.setAttribute("lang", LANG);

        // Drug
        const dId = drug && DRUG_INDEX[drug] ? drug : DRUGS[0].id;
        drugSel.value = dId;
        populateConcs();
        updateChip();

        // Mode
        showMode(m);

        // Apply defaults (only if missing); then override with URL if present/valid
        applyDrugDefaults(false);

        if (conc && Array.from(concSel.options).some((o) => o.value === conc)) {
          concSel.value = conc;
        }

        // Values
        setIfProvided(B, b, to1); // single weight field used in both modes
        if (mode === "forward") {
          setIfProvided(P, p, to2);
          if (rate != null && isFinite(rate)) Rate.value = to2(rate);
        } else {
          setIfProvided(RateIn, rate, to2);
          if (p != null && isFinite(p)) Pout.value = to2(p);
        }
      }

      /* ------------------ Init ------------------ */
      function init() {
        populateDrugOptions();
        attachEvents();
        hydrateFromURL();
        booting = false;
        recalc();
        updateShareLink();
      }
      init();
    </script>
  </body>
</html>
